<h1><%= @opening.title %></h1>

<p><%= @opening.description %></p>


<% if current_user.admin? %>
    <ul>
      <li><%= link_to "Edit", edit_opening_path(@opening) %></li>
    </ul>

    <ul>
      <li><%= link_to "Delete", opening_path(@opening), 
                      method: :delete,
                      data: { confirm: "Are you sure?" } %></li>
    </ul>

    <% if !@opening.feedbacks.empty? %>
          <h4>Feedbacks</h4>
          <% @opening.feedbacks.each do |feedback| %>
            <p>
              <strong><%= User.find(feedback.uid).email%></strong>
              <%= feedback.body %>
            </p>
          <% end %>
    <% end %>


    <% @users = Opportunity.where(:opid =>@opening.id) %>

        <table>
          <thead>
            <tr>
              <th>Email ID</th>
              <th>Username</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |u| %>
              <% @userid = u.uid %>
              <tr>
                <td><%= User.find(@userid).email %> </td>
                <td><%= User.find(@userid).username %> </td>
              </tr>
            <% end %>
          </tbody>
        </table>

<% else %>

    <% if !Opportunity.where(:uid => current_user.id).where(:opid => @opening.id).exists? %>

        <%= link_to "Apply",applyForm_path(@opening)%>
        
        <% if !@opening.feedbacks.empty? %>
          <h4>Feedbacks</h4>
          <% @opening.feedbacks.each do |feedback| %>
            <p>
              <strong><%= User.find(feedback.uid).email%></strong>
              <%= feedback.body %>
            </p>
          <% end %>
        <% end %>
    <%else%>

    <% if !@opening.feedbacks.empty? %>
          <h4>Feedbacks</h4>
          <% @opening.feedbacks.each do |feedback| %>
            <p>
              <strong><%= User.find(feedback.uid).email%></strong>
              <%= feedback.body %>
            </p>
          <% end %>
    <% end %>

      <%= form_with model: [ @opening, @opening.feedbacks.build ] do |form| %>
      <p>
        <%= form.label :Feedback %><br>
        <%= form.text_area :body %>
      </p>
      <p>
        <%= form.submit %>
      </p>

    <% end %>
  
    <%end%>
<% end %>
